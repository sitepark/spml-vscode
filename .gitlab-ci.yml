image: node:lts-slim

stages:
  - build

build-lspml:
  stage: build
  image: rust:latest
  variables:
    CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  script:
    - git clone https://github.com/DrWursterich/lspml.git
    - cargo build --manifest-path ./lspml/Cargo.toml --release
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .cargo/bin
      - .cargo/registry/index
      - .cargo/registry/cache
      - target/debug/deps
      - target/debug/build
    policy: pull-push
  artifacts:
    paths:
      - lspml/target/release/lspml
    expire_in: 20 minutes

build-vscode-extension:
  stage: build
  cache: # Cache modules in between jobs
    key: $CI_COMMIT_REF_SLUG
    paths:
      - .npm/
  before_script:
    - npm ci --cache .npm --prefer-offline
  needs:
    - build-lspml
  script:
    - cp lspml/target/release/lspml ./resources/lspml_x86
    - ./node_modules/.bin/vsce pack --out ./spml-vscode.vsix
  artifacts:
    paths:
      - spml-vscode.vsix
    expire_in: "30 days"
    expose_as: "vscode-extension"
